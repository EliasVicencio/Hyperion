<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperion - Monitor de Seguridad</title>
    <link rel="icon" href="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f6e1.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        @keyframes pulse-yellow {
            0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }
        .pulse { animation: pulse-red 2s infinite; }
        .pulse-emergency { animation: pulse-yellow 2s infinite; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 p-4 md:p-8 font-sans">
    
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-10 border-b border-slate-700 pb-6">
            <div>
                <h1 class="text-3xl font-extrabold text-blue-500 tracking-tight">üõ°Ô∏è HYPERION REAL-TIME</h1>
                <p class="text-slate-400 text-sm mt-1">Panel de Control de Amenazas Perimetrales</p>
            </div>
            <div id="system-status" class="bg-yellow-500/10 text-yellow-500 px-4 py-2 rounded-lg border border-yellow-500/20 text-xs font-bold tracking-widest uppercase">
                ‚óè CONECTANDO...
            </div>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl transition hover:border-slate-500">
                <h3 class="text-slate-500 text-xs font-black uppercase tracking-wider mb-2">Intentos Fallidos Totales</h3>
                <p id="total-attempts" class="text-5xl font-black text-white">--</p>
            </div>
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl transition hover:border-slate-500">
                <h3 class="text-slate-500 text-xs font-black uppercase tracking-wider mb-2">IPs bajo Restricci√≥n</h3>
                <p id="watched-ips" class="text-5xl font-black text-blue-500">--</p>
            </div>
        </main>

        <section class="mb-10 bg-slate-800 rounded-2xl border border-red-900/30 overflow-hidden shadow-2xl">
            <div class="bg-red-950/20 p-4 border-b border-slate-700 flex items-center gap-2">
                <span class="text-red-500 animate-pulse">üîî</span>
                <h2 class="text-sm font-bold text-red-400 uppercase tracking-widest">Alertas del Sistema (Logs)</h2>
            </div>
            <div id="alerts-container" class="p-4 space-y-2 max-h-48 overflow-y-auto">
                <p class="text-slate-500 text-xs italic text-center py-4">Sincronizando logs...</p>
            </div>
        </section>

        <button onclick="checkIntegrity()" class="mb-4 bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-xs uppercase tracking-widest transition-all shadow-lg flex items-center gap-2">
    üõ°Ô∏è Verificar Integridad de Logs
        </button>

        <section class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shadow-2xl">
            <div class="bg-slate-700/50 p-4 border-b border-slate-700">
                <h2 class="text-sm font-bold text-slate-300 uppercase tracking-widest">üö´ Registro de Actividad Sospechosa</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-800 text-slate-400 text-xs uppercase">
                        <tr>
                            <th class="p-4">Direcci√≥n IP</th>
                            <th class="p-4 text-center">Intentos</th>
                            <th class="p-4">Estado Actual</th>
                            <th class="p-4">Bloqueado Hasta</th>
                            <th class="p-4 text-center">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="log-table" class="divide-y divide-slate-700/50">
                        <tr><td colspan="5" class="p-8 text-center text-slate-600">Cargando datos perimetrales...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="mt-10 mb-10 bg-slate-800 rounded-2xl border border-blue-900/30 overflow-hidden shadow-2xl fade-in">
            <div class="bg-blue-950/20 p-4 border-b border-slate-700 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-blue-500">üîë</span>
                    <h2 class="text-sm font-bold text-blue-400 uppercase tracking-widest">Acceso de Emergencia (2FA Backup)</h2>
                </div>
            </div>
            <div class="p-6 flex flex-col md:flex-row items-center justify-between gap-4">
                <div>
                    <p class="text-slate-300 text-sm font-medium">Generar nuevos c√≥digos de respaldo</p>
                    <p class="text-slate-500 text-xs mt-1">Al descargar el .txt, los c√≥digos anteriores dejar√°n de funcionar.</p>
                </div>
                <button onclick="downloadBackups()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold text-xs uppercase tracking-widest transition-all shadow-lg active:scale-95 border border-blue-400/30">
                    üì• Descargar .TXT
                </button>
            </div>
        </section>

        <section class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shadow-2xl">
            <div class="bg-indigo-900/30 p-4 border-b border-slate-700">
                <h2 class="text-sm font-bold text-indigo-300 uppercase tracking-widest">üîç Auditor√≠a de C√≥digo (Bandit)</h2>
            </div>
            <div id="scan-container" class="p-6 grid grid-cols-1 gap-4 text-xs">
                <p class="text-slate-500 italic text-center">Iniciando esc√°ner de seguridad...</p>
            </div>
        </section>

        <footer class="mt-8 text-center text-slate-600 text-[10px] uppercase tracking-widest pb-10">
            Hyperion Security Engine v3.0 - Dashboard Externo
        </footer>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const BASE_URL = window.location.origin; 

        async function deleteIP(ip) {
            if(!confirm(`¬øDesbloquear IP: ${ip}?`)) return;
            try {
                const res = await fetch(`${BASE_URL}/api/clear-ip/${ip}?token=${token}`, { method: 'DELETE' });
                if (res.ok) update(); 
            } catch (e) { console.error("Error al borrar IP:", e); }
        }

        async function downloadBackups() {
            let email = localStorage.getItem("user_email") || prompt("Ingresa el email para generar c√≥digos:");
            if (!email) return;

            if (confirm("‚ö†Ô∏è Al generar nuevos c√≥digos, los antiguos se invalidar√°n. ¬øContinuar?")) {
                try {
                    const res = await fetch(`${BASE_URL}/api/download-backup-codes?email=${email}&token=${token}`);
                    if (res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `backup_codes_${email}.txt`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        
                        // Forzamos actualizaci√≥n inmediata para ver la alerta
                        setTimeout(update, 500); 
                    } else {
                        alert("Error al descargar c√≥digos. Verifique permisos.");
                    }
                } catch (e) {
                    console.error("Error en descarga:", e);
                }
            }
        }

        async function update() {
            if (!token) {
                document.body.innerHTML = "<div class='h-screen flex items-center justify-center bg-slate-950 text-red-500 font-bold uppercase tracking-tighter'>TOKEN DE ACCESO REQUERIDO</div>";
                return;
            }

            try {
                // 1. IPs Y M√âTRICAS (La tabla que ya te funciona)
                const res = await fetch(`${BASE_URL}/api/security-status?token=${token}`);
                const data = await res.json();
                
                document.getElementById('total-attempts').innerText = data.total_attempts || 0;
                document.getElementById('watched-ips').innerText = data.blocked_ips ? data.blocked_ips.length : 0;

                const body = document.getElementById('log-table');
                if (!data.blocked_ips || data.blocked_ips.length === 0) {
                    body.innerHTML = '<tr><td colspan="5" class="p-12 text-center text-slate-500 italic">üõ°Ô∏è Per√≠metro Seguro</td></tr>';
                } else {
                    body.innerHTML = ''; 
                    data.blocked_ips.forEach(item => {
                        body.innerHTML += `
                            <tr class="bg-red-500/5 fade-in">
                                <td class="p-4 font-mono font-bold text-blue-400">${item.ip}</td>
                                <td class="p-4 text-center font-bold">${item.attempts}</td>
                                <td class="p-4 text-xs">
                                    <span class="bg-red-500/20 text-red-400 border border-red-500/50 px-3 py-1 rounded-full font-black uppercase tracking-tighter pulse">
                                        ${item.status || 'BLOQUEADO'}
                                    </span>
                                </td>
                                <td class="p-4 text-slate-400 font-mono text-xs">${item.until || '--:--'}</td>
                                <td class="p-4 text-center">
                                    <button onclick="deleteIP('${item.ip}')" class="bg-slate-700 hover:bg-red-600 p-2 rounded-lg transition-all">üóëÔ∏è</button>
                                </td>
                            </tr>`;
                    });
                }

                // 2. LOG DE ALERTAS (El que se quedaba trabado)
                // He a√±adido una validaci√≥n extra por si tu API devuelve 'history' en lugar de un array directo
                const smsRes = await fetch(`${BASE_URL}/api/sms-history?token=${token}`);
                let smsData = await smsRes.json();
                
                // Si smsData no es un array directamente, intentamos buscarlo dentro de la respuesta
                if (!Array.isArray(smsData) && smsData.history) smsData = smsData.history;

                const alertsContainer = document.getElementById('alerts-container');
                
                if (smsData && smsData.length > 0) {
                    alertsContainer.innerHTML = ''; // Limpiamos el "Sincronizando..."
                    smsData.forEach(sms => {
                        const msgUpper = sms.msg.toUpperCase();
                        const isEmergency = msgUpper.includes("EMERGENCIA") || msgUpper.includes("AVISO") || msgUpper.includes("BACKUP");

                        const colorClass = isEmergency ? "border-yellow-500/50 bg-yellow-500/10" : "border-red-500/50 bg-red-500/10";
                        const textClass = isEmergency ? "text-yellow-500 font-bold" : "text-red-400";
                        const pulseClass = isEmergency ? "pulse-emergency" : "";

                        alertsContainer.innerHTML += `
                            <div class="${colorClass} ${pulseClass} border-l-4 p-2 text-[11px] flex justify-between items-center fade-in mb-1 rounded-r">
                                <span><b class="${textClass} uppercase mr-2">${isEmergency ? '‚ö†Ô∏è AVISO:' : 'üö® AMENAZA:'}</b> ${sms.msg}</span>
                                <span class="text-slate-500 font-mono text-[9px] bg-slate-900/50 px-2 py-0.5 rounded">${sms.time}</span>
                            </div>`;
                    });
                } else {
                    alertsContainer.innerHTML = '<p class="text-slate-600 text-xs text-center py-4 italic">No hay alertas recientes en el log.</p>';
                }

                // 3. AUDITOR√çA BANDIT
                const scanRes = await fetch(`${BASE_URL}/api/scan-results?token=${token}`);
                const scans = await scanRes.json();
                const scanContainer = document.getElementById('scan-container');
                if (scans && scans.length > 0) {
                    scanContainer.innerHTML = '';
                    scans.forEach(s => {
                        const hasIssues = s.issues_found > 0;
                        scanContainer.innerHTML += `
                            <div class="border ${hasIssues ? 'border-red-500/50 bg-red-500/10' : 'border-green-500/50 bg-green-500/10'} p-4 rounded-xl flex justify-between items-center fade-in">
                                <div><p class="font-bold text-slate-200">${s.repo}</p></div>
                                <div class="${hasIssues ? 'text-red-500 font-black' : 'text-green-500 font-bold'}">${s.issues_found} VULNERABILIDADES</div>
                            </div>`;
                    });
                }

                const statusLabel = document.getElementById('system-status');
                statusLabel.innerText = "‚óè SISTEMA ACTIVO";
                statusLabel.className = "bg-green-500/10 text-green-500 px-4 py-2 rounded-lg border border-green-500/20 text-xs font-bold tracking-widest uppercase";

            } catch (e) {
                console.error("Error en el ciclo de actualizaci√≥n:", e);
                const statusLabel = document.getElementById('system-status');
                statusLabel.innerText = "‚óè ERROR DE CONEXI√ìN";
                statusLabel.className = "bg-red-500/10 text-red-500 px-4 py-2 rounded-lg border border-red-500/20 text-xs font-bold tracking-widest uppercase pulse";
            }
        }

        setInterval(update, 3000);
        update();

        async function checkIntegrity() {
            const res = await fetch(`${BASE_URL}/admin/audit/verify?token=${token}`);
            const data = await res.json();
            
            if (data.status === "SECURE") {
                alert("‚úÖ " + data.message);
            } else {
                alert("üö® ¬°ALERTA DE SEGURIDAD!: " + data.message);
                update(); // Para que se vea la alerta roja arriba inmediatamente
            }
        }
    </script>
</body>
</html>